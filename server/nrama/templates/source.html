<div class="source">
    {?source}
        {#source}
            <h1>
                <a href="{url}" target="_blank" class="title">{TITLE}</a>
            </h1>
            <span class="authors">
                {#AUTHOR}
                    <span class="author_{@idx}{.}{/idx}">{.}</span>{@sep} and {/sep}
                {/AUTHOR}
            </span>
            (<span class="year">{YEAR}</span>).
            {?JOURNAL}
                <span class="journal">{JOURNAL}</span>
                {VOLUME}({NUMBER}).
                {?PAGES}
                    pp. <span class="PAGES">{PAGES}</span>.
                {/PAGES}
            {/JOURNAL}
            {?BOOKTITLE}
                In <span class="booktitle">{BOOKTITLE}</span>
                {?EDITOR}
                    (eds.) <span class="editor">{EDITOR}</span>.
                {/EDITOR}
                <span class="publisher">{PUBLISHER}</span>:
                <span class="address">{ADDRESS}</span>.
                {?PAGES}
                    pp. <span class="PAGES">{PAGES}</span>.
                {/PAGES}
            {/BOOKTITLE}
        {:else}
            <h1>
                <a href="{url}" target="_blank" class="title">{title}</a>
            </h1>
        {/source}
    {/source}
    
    {?user_id}
        <h2>{user_id}'s notes</h2>
        <p>Updated <abbr class="updated_time _timeago" title="{source.updated_time}">{source.updated_time}</abbr>.
    {:else}
        <h2>Everyone's notes</h2>
        {?source}
            <p>Updated by {source.user_id} <abbr class="updated_time _timeago" title="{source.updated_time}">{source.updated_time}</abbr>.
        {/source}
    {/user_id}
    
    
    {?quotes}
        {#quotes}
            <div class="quote" id="{_id}" >
                {?is_user_page}
                {:else}
                    [<span class='quote-user_id'>{user_id}</span>]
                {/is_user_page}
                "<span class="quote-content">{content}</span>"
                [{page_order}]
                {?is_user_page}
                    <span class="add-a-note">[+]</span>
                {/is_user_page}
                <ul class="notes _sort-me">
                    {#notes}
                        <li class="note">
                            {! display textarea if user can edit on this page, otherwise just the text !}
                            {?is_user_page}
                                <textarea id="{_id}" class="note-content">{content}</textarea>
                            {:else}
                                [<span class='quote-user_id'>{user_id}</span>] <span class="note-content">{content}</span>
                            {/is_user_page}
                        </li>
                    {/notes}
                </ul>
            </div>
        {/quotes}
    {:else}
        {?user_id}
            <p>{user_id} has no notes on this source.</p>
        {:else}
            <p>There are no notes on this source.</p>
        {/user_id}
    {/quotes}
    
    {! menu !}
    <ul>
        {?user_id}
            <li>
                See <a href="{baseURL}/source/{page_id|uc}">everyone's notes on this source</a>.
            </li>
        {:else}
            {?userCtx.name}
            <li>
                See (and edit) <a href="{baseURL}/user/{userCtx.name}/source/{page_id|uc}"> only your notes on this source</a>
            </li>
            {/userCtx.name}
        {/user_id}
        {?userCtx.name}
            <li>See <a href="{baseURL}/user/{userCtx.name}">your sources</a>.</li>
        {/userCtx.name}
        <li>
            See <a href = "{baseURL}/sources">everyone's sources</a>
        </li>
    </ul>
    
</div>

<script>
    if( typeof($)!='undefined' ) {
        $('._sort-me').sortlist();
        $('textarea.note-content').autogrow();
    }
</script>
